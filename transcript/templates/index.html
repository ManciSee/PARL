<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8">
  <title>Audio Inventory</title>
  <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../styles/styles.css">


</head>

<body class="flex items-center justify-center h-screen bg-gray-200">
  <div
    class="text-center p-8 bg-white rounded-2xl shadow-2xl transition duration-300 ease-in-out transform hover:scale-105">
    <h1 class="text-4xl font-bold text-gray-800">Audio Inventory</h1>
    <p class="mt-2 text-md text-gray-600">Avvia la registrazione e parla chiaramente, poi premi stop per ottenere la
      trascrizione. Oppure carica un file WAV per ottenere la trascrizione.</p>
    <div class="mt-6 relative">
      <a id="start-btn"
        class="btn-start inline-block px-6 py-3 mx-2 bg-green-500 text-white rounded-lg font-semibold shadow-md cursor-pointer hover:bg-green-600 transition duration-200">Avvia
        Registrazione</a>
      <div id="recording-indicator" class="hidden"></div>

      <a id="stop-btn" style="display: none;"
        class="btn-stop inline-block px-6 py-3 mx-2 bg-red-500 text-white rounded-lg font-semibold shadow-md cursor-pointer hover:bg-red-600 transition duration-200 ">Interrompi
        Registrazione</a>
    </div>
    <div id="transcription-box" class="mt-6 p-6 bg-blue-400 text-white rounded-lg shadow-inner">
      <div id="t-int-box">
        <p id="transcript" tp="trascription" style="display: none;" class="font-semibold text-lg mb-4"></p>
      </div>
      <button id="clearBtn" style="display: none;"
        class="btn-clear text-blue-400 bg-white px-4 py-2 rounded font-medium hover:bg-gray-100 transition duration-200"
        onclick="clearTranscription()">Cancella</button>
    </div>
    <div class="mt-8">
      <input type="file" id="fileInput" class="block mb-4 p-2 w-full mx-auto border-2 border-gray-300 rounded-lg ">
      <button onclick="uploadFile()"
        class="btn-upload inline-block px-6 py-3 bg-blue-400 text-white rounded-lg font-semibold shadow-md hover:bg-blue-500 transition duration-200 ">Carica
        e Trascrivi</button>


    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>



  <script>

    function uploadFile() {
      const input = document.getElementById('fileInput');
      const file = input.files[0];
      if (file) {
        const formData = new FormData();
        formData.append('file', file);

        // fetch('http://localhost:8880/upload', {
        //     method: 'POST',
        //     body: formData,
        // })
        fetch('http://192.168.66.231:8880/upload', {
          method: 'POST',
          body: formData,
        })
          .then(response => {
            if (response.ok) {
              response.text().then((jsonString) => {
                let respObject = JSON.parse(jsonString)
                let cloneEl = document.createElement('p')
                cloneEl.setAttribute('tp', 'trascription')
                cloneEl.textContent = respObject["text"]

                document.getElementById('transcript').innerHTML = ""
                var contenitore = document.querySelector('#t-int-box'); // Assicurati che esista un elemento con id="contenitore" nel tuo HTML
                contenitore.append(cloneEl)
                document.getElementById('clearBtn').style.display = 'inline'


                return respObject["text"]
              })

            } else {
              throw new Error('Network response was not ok.');
            }
          })
          .then(data => {
            // console.log('File uploaded successfully:', data);
          })
          .catch(error => {
            console.error('There has been a problem with your fetch operation:', error);
          });
      }
    }

    function clearTranscription() {
      let allElements = document.querySelectorAll('p[tp=trascription]')
      for (let el of allElements) el.remove()
      document.getElementById('clearBtn').style.display = 'none'

    }
    // Controlla se il browser supporta l'API Web Speech
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (typeof SpeechRecognition !== "undefined") {
      let recognition = new SpeechRecognition();
      let isRecording = false;
      let startTime, endTime; // Variabili per conservare i timestamp di inizio e fine

      recognition.continuous = true; // Continua a ascoltare anche dopo aver rilevato l'input
      recognition.lang = "it-IT"; // Imposta la lingua italiana
      recognition.interimResults = false; // I risultati intermedi non sono necessari

      function sendTranscript(text, duration) {
        // Invia il testo e la durata tramite una richiesta HTTP POST
        // fetch('http://localhost:8880/sendRecording', { // Sostituisci con l'URL effettivo del server
        //   method: 'POST',
        //   headers: {
        //     'Content-Type': 'application/json',
        //   },
        fetch('http://192.168.66.231:8880/sendRecording', { // Sostituisci con l'URL effettivo del server
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ text: text, duration: duration }),
        })
          .then(response => response.json())
          .then(data => console.log('Success:', data))
          .catch((error) => console.error('Error:', error));
      }

      recognition.onstart = function () {
        console.log("Il riconoscimento vocale Ã¨ attivo.");
        document.getElementById("start-btn").style.display = "none";
        document.getElementById("stop-btn").style.display = "inline";
        isRecording = true;
        startTime = new Date(); // Registra il timestamp di inizio
      };

      recognition.onresult = function (event) {
        // Accedi al risultato del riconoscimento vocale
        const transcript = event.results[event.resultIndex][0].transcript;
        document.getElementById("transcript").textContent += transcript;
      };

      recognition.onend = function () {
        endTime = new Date(); // Registra il timestamp di fine
        const duration = (endTime - startTime) / 1000; // Calcola la durata in secondi
        if (isRecording) {
          sendTranscript(document.getElementById("transcript").textContent, duration);
          isRecording = false;
        }
        document.getElementById("start-btn").style.display = "inline";
        document.getElementById("stop-btn").style.display = "none";
        let cloneEl = document.createElement('p')
        cloneEl.setAttribute('tp', 'trascription')
        cloneEl.textContent = document.getElementById('transcript').textContent

        document.getElementById('transcript').innerHTML = ""
        var contenitore = document.querySelector('#t-int-box'); // Assicurati che esista un elemento con id="contenitore" nel tuo HTML
        contenitore.append(cloneEl)
        document.getElementById('clearBtn').style.display = 'inline'
      };

      recognition.onerror = function (event) {
        console.error("Errore nel riconoscimento vocale: ", event.error);
      };

      document.getElementById("start-btn").addEventListener("click", function () {
        recognition.start(); // Avvia il riconoscimento vocale
      });

      // Aggiungi listener al pulsante di stop
      document.getElementById("stop-btn").addEventListener("click", function () {
        recognition.stop(); // Ferma il riconoscimento vocale
      });
    } else {
      console.log("Il tuo browser non supporta l'API Web Speech.");
    }

    document.getElementById('start-btn').addEventListener('click', function () {
      var indicator = document.getElementById('recording-indicator');
      indicator.classList.toggle('hidden'); // This will show the recording indicator
      // Start recording logic here
    });
  </script>
</body>

</html>